# ゲームランチャーアプリ 仕様書

## 1. 概要

本ドキュメントは「ゲームランチャーアプリ 要件定義書」に基づき、アプリケーションの技術仕様および動作仕様を定義する。

## 2. 開発環境・技術スタック

- **開発プラットフォーム**: Windows
- **動作対象OS**: Windows 10/11
- **フレームワーク**: Electron
- **UIライブラリ**: React (TypeScript)
- **状態管理**: Jotai (原子的な状態管理により、UIのパフォーマンスと複雑な状態管理に優れるため)
- **スタイリング**: Tailwind CSS (モダンで洗練されたUIを効率的に構築でき、かつデザインの一貫性を保ちやすいため)
- **パッケージ管理**: npm

## 3. 機能仕様

### 3.1. 画面仕様

#### 3.1.1. メインライブラリ画面

- **レイアウト**:
  - ゲームのカバーアートをアスペクト比を保ったままグリッド表示する。
  - ウィンドウサイズに応じてグリッドのカラム数を動的に変更する（レスポンシブ対応）。
  - 右上または左上に「ゲームを手動で追加」ボタンと「設定」ボタンを配置する。
- **インタラクション**:
  - ゲームカバーにマウスオーバーすると、若干拡大するなどのエフェクトを適用する。
  - ゲームカバーをクリックすると、ゲーム起動の確認、またはゲーム詳細画面へ遷移する（どちらにするか要検討）。

#### 3.1.2. ゲーム手動追加モーダル

- **UIコンポーネント**:
  - 「ゲームタイトル」入力用のテキストフィールド。
  - 「実行ファイルパス」表示用のテキストエリア（読み取り専用）。
  - 「実行ファイルを選択」ボタン。クリックするとOSのファイル選択ダイアログが開き、`.exe` ファイルを選択できる。
  - 「カバーアート画像」表示用のプレビューエリア。
  - 「画像を選択」ボタン。クリックするとOSのファイル選択ダイアログが開き、画像ファイル（jpg, png）を選択できる。
  - **（任意）「背景ビデオを選択」ボタン**。クリックするとOSのファイル選択ダイアログが開き、ビデオファイル（mp4, webm）を選択できる。
  - 「保存」ボタンと「キャンセル」ボタン。

#### 3.1.3. ゲーム選択時の背景表示

- ゲームをライブラリで選択（フォーカス）すると、ウィンドウの背景がそのゲーム専用の表示に切り替わる。
- **ビデオ再生**: Steam APIから取得したムービー情報、または手動で設定したビデオファイルのパスが存在する場合、HTMLの `<video>` タグを用いて背景でビデオを自動再生する（ミュート、ループ再生）。
- **静止画フォールバック**: 対応するビデオが存在しない場合は、代わりに高解像度の背景静止画を表示する。

### 3.2. 処理仕様

#### 3.2.1. Steamゲームの自動検出処理

1.  **初回起動時**:
    - Steamのインストールパスをレジストリ (`HKEY_CURRENT_USER\Software\Valve\Steam\SteamPath`) から取得する。
    - Steamのインストールパス配下にある `config/libraryfolders.vdf` をパースし、ゲームがインストールされている全ライブラリフォルダのパスを取得する。
    - 各ライブラリフォルダ内の `steamapps/` にある `appmanifest_<AppID>.acf` ファイルを全てスキャンする。
    - `acf` ファイルから `AppID` と `name` を抽出する。
    - 抽出した `AppID` のリストを元に、Steam Web API (`appdetails`) を使用して、各ゲームのヘッダー画像URL (`header_image`) およびムービー情報 (`movies`) を取得する。
      - **注意**: APIキーが設定されていない場合は、API連携をスキップし、ローカル情報のみで表示するか、設定を促すメッセージを表示する。
    - 取得したゲーム情報（AppID, 名前, カバーアートURL）をローカルにキャッシュする（例: JSONファイル）。
2.  **2回目以降の起動時**:
    - まずローカルキャッシュを読み込んで画面を表示する。
    - その後、バックグラウンドで差分更新処理を行う。

#### 3.2.2. 手動追加ゲームの管理処理

- **データ保存**:
  - 手動で追加されたゲームの情報（タイトル, 実行パス, カバーアートパス）は、単一のJSONファイルに配列として保存する。
  - 保存先は `%APPDATA%\<アプリ名>\manual_games.json` とする。これにより、アプリを再インストールしても設定が維持される。
  - カバーアートは、指定されたパスを直接参照するのではなく、アプリのデータフォルダ内にコピーして管理する。これにより、元の画像が移動・削除されても表示が崩れないようにする。
- **データの読み込み**:
  - アプリ起動時に `manual_games.json` を読み込み、Steamゲーム情報とマージしてライブラリ画面に表示する。

#### 3.2.3. ゲーム起動処理

- **Steamゲーム**:
  - ユーザーがライブラリでSteamゲームを選択し、起動アクションを実行。
  - Electronのメインプロセス（Node.js）から、OSのシェル機能を利用して `steam://run/<AppID>` コマンドを実行する。
- **手動追加ゲーム**:
  - ユーザーがライブラリで手動追加ゲームを選択し、起動アクションを実行。
  - Electronのメインプロセス（Node.js）から、登録されている実行ファイルパスを `child_process` モジュールなどで実行する。

### 3.3. エラー処理と初回起動時の体験

- **エラーハンドリング**:
  - Steamのインストールパスが見つからない場合や、`libraryfolders.vdf` のパースに失敗した場合は、ユーザーに分かりやすいエラーメッセージを表示し、手動での設定を促す。
  - Steam Web APIからの情報取得に失敗した場合（ネットワークエラー、APIキー不正など）は、エラー通知を行い、APIキー設定画面への誘導、またはリトライの選択肢を提供する。
  - 手動追加ゲームの実行ファイルパスが無効になった場合、起動時にエラーメッセージを表示し、情報の更新または削除を促す。
  - 大容量の画像ファイルがカバーアートとして選択された場合、リサイズ処理を行うか、警告を表示してユーザーに選択を委ねる。
- **初回起動時のオンボーディング**:
  - アプリケーション初回起動時に、簡単なウェルカム画面を表示し、主要機能（Steamゲームの自動検出、手動追加、設定）について説明する。
  - Steam APIキーが未設定の場合、設定画面への誘導を促す。

### 3.4. データ管理と更新戦略

- **キャッシュの鮮度**:
  - Steamゲーム情報は、初回取得後も定期的に（例: 起動時、または一定時間経過後）バックグラウンドで差分チェックを行い、更新する。
  - ユーザーが手動でゲームリストの更新をトリガーできる「ライブラリ更新」ボタンを設ける。
- **データ永続化**:
  - キャッシュデータや手動追加ゲームデータは、アプリケーションのバージョンアップ後も互換性が保たれるように管理する。必要に応じてデータ移行処理を実装する。

## 4. データ構造

### 4.1. ゲーム情報オブジェクト（共通）

```json
{
  "id": "string", // Steamゲームの場合はAppID, 手動の場合はUUIDなど
  "type": "steam" | "manual",
  "title": "string",
  "coverArt": "string", // URLまたはローカルファイルのパス
  "backgroundVideo": "string | null" // (任意) ビデオのURLまたはローカルファイルのパス
}
```

### 4.2. 手動追加ゲーム設定ファイル (`manual_games.json`)

```json
[
  {
    "id": "uuid-v4-string-1",
    "title": "My Awesome Game",
    "executablePath": "C:\\Games\\AwesomeGame\\game.exe",
    "coverArtPath": "C:\\Users\\akats\\AppData\\Roaming\\<AppName>\\covers\\uuid-v4-string-1.png",
    "backgroundVideoPath": "C:\\Users\\akats\\AppData\\Roaming\\<AppName>\\videos\\uuid-v4-string-1.mp4" // (任意)
  }
]
```